# 后端各层职责说明（pet_book）

本项目的后端采用经典分层：**controller → service → mapper**，配合 **entity**、**vo**、**handler**。各层只做自己该做的事，避免逻辑重复和混乱。

---

## 一、各层是干什么的

| 层 | 包名 | 职责 | 不该做的事 |
|----|------|------|------------|
| **Controller** | `controller` | 接收 HTTP 请求、校验入参、调用 Service、返回统一格式（如 `Result<T>`） | 不写业务逻辑、不直接访问数据库、不拼复杂对象 |
| **Service** | `service` + `service.impl` | 业务逻辑：编排 Mapper/多表、转换参数、组装 VO、事务 | 不解析 HTTP、不写 SQL |
| **Mapper** | `mapper` | 数据库访问：执行 SQL（XML 或注解），返回 Entity 或 VO 所需字段 | 不写业务判断、不调其他 Mapper 做复杂编排 |
| **Entity** | `entity` | 与数据库表一一对应的 Java 对象，字段与表结构一致 | 不包含“给前端看的”衍生字段（如中文频道名） |
| **VO** | `vo` | 给前端的视图对象：接口返回用，字段与前端约定一致（如 PostCardVO、PostDetailVO） | 不替代 Entity 做持久化 |
| **Handler** | `handler` | MyBatis 的 TypeHandler：把 DB 里某种类型（如 JSON 字符串）与 Java 类型（如 `List<String>`）互转 | 只做类型转换，不写业务 |

---

## 二、数据流关系

- **请求进来**：Controller 拿到 `channel`、`page`、`size` 等 → 转给 Service。
- **Service**：把 `channel`（如 `"adopt"`）转成表里的 `category`（如 1），调 Mapper 查库；把查到的 Entity 或原始结果组装成 VO（如补 `channel` 中文名、封面图从 JSON 取第一张）。
- **Mapper**：只负责执行 SQL，返回的可以是 Entity，也可以是 VO 所需字段（通过 XML 的 resultType/resultMap 映射）。
- **返回**：Controller 用 `Result.success(vo)` 返回给前端。

**Entity 与 VO 区别**：Entity 对应“表里存什么”；VO 对应“接口要返回什么”。例如 Post 表存 `category=1`、`images=["a","b"]`，而 PostCardVO 给前端的是 `channel="领养"`、`coverUrl="a"`（只取第一张图）。

---

## 三、本项目里各包对应关系

- **controller**：`PostController`（帖子流、详情、点赞）、`PetController`（添加宠物）。只做参数接收与 `Result` 返回。
- **service**：`PostService` 接口 + `PostServiceImpl`。例如 feed 的频道转换、封面图从 JSON 取第一张、详情里是否点赞/收藏/关注。
- **mapper**：`PostMapper`、`PetMapper`、`InteractionMapper`。SQL 在对应 XML 里（如 `PostMapper.xml`）。
- **entity**：`Post`、`User`、`Pet`、`Interaction`。与表 `post`、`user`、`pet`、`interaction` 对应。
- **vo**：`PostCardVO`（列表卡片）、`PostDetailVO`（详情弹窗）。与前端类型对齐。
- **handler**：`JsonTypeHandler`。把 DB 里 `post.images` 的 JSON 字符串与 `List<String>` 互转（用于 Entity 或 VO 的 resultMap）。

---

## 四、多余或重复时要删什么

- **逻辑重复**：同一段“频道转 category”或“取第一张图”只保留在 **Service** 一处，Controller 和 Mapper 不重复写。
- **多余类**：没有在 Controller/Service/Mapper 里被引用的 Entity/VO 可以删；没有在 XML 或 Entity 上使用的 Handler 可以删。当前项目没有多余类，Handler 用于 Post 的 images 映射。
- **混用职责**：例如在 Controller 里写 SQL 或拼 VO、在 Mapper 里写业务判断，都应挪到 Service 或 Mapper 对应层。

按上述分工整理后，后续加“评论、用户资料、通知”等接口时，也是：**Controller 只接参和返回，Service 写逻辑，Mapper 只查/写库，VO 定好和前端一致的字段**。
