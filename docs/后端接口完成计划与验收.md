# 后端接口完成计划与验收

目标：**把所有设计文档中的接口暴露给前端，并具备可验收的测试方式**。本文档列出：已完成 / 未完成、实施顺序、数据库依赖、以及「后端全部开发好」的验收标准。

---

## 一、接口完成情况总览

### 1.1 帖子（/api/post）

| 方法 | 路径 | 状态 | 说明 |
|------|------|------|------|
| GET | /api/post/feed | ✅ 已完成 | 参数 channel, page, size |
| GET | /api/post/{id} | ✅ 已完成 | 帖子详情 |
| POST | /api/post | ❌ 未完成 | 发布笔记，需入参：title, content, channel, images |
| POST | /api/post/{id}/like | ✅ 已完成 | 点赞/取消点赞 |
| POST | /api/post/{id}/collect | ❌ 未完成 | 收藏/取消收藏（逻辑同 like，type=2） |
| GET | /api/post/{id}/like-status | ⏸ 可选 | 查当前用户是否已点赞/收藏，可由详情接口带出，可不做 |

### 1.2 评论（/api/post/{id}/comments）

| 方法 | 路径 | 状态 | 说明 |
|------|------|------|------|
| GET | /api/post/{id}/comments | ❌ 未完成 | 评论列表分页，含子评论，需 **comment 表** |
| POST | /api/post/{id}/comments | ❌ 未完成 | 发表评论/回复，Body: content, parentId?，需 **comment 表** |

### 1.3 用户与关注（/api/user）

| 方法 | 路径 | 状态 | 说明 |
|------|------|------|------|
| GET | /api/user/profile | ❌ 未完成 | 当前用户资料 + 宠物 + 关注/粉丝/获赞数，需 **user 表、follow 表、pet 表** |
| GET | /api/user/{userId}/profile | ❌ 未完成 | 他人主页资料（同上） |
| POST | /api/user/{userId}/follow | ❌ 未完成 | 关注/取关，需 **follow 表** |

### 1.4 个人页列表（/api/user/{userId}/...）

| 方法 | 路径 | 状态 | 说明 |
|------|------|------|------|
| GET | /api/user/{userId}/posts | ❌ 未完成 | 该用户发布的笔记，复用 feed 逻辑按 user_id 过滤 |
| GET | /api/user/{userId}/collects | ❌ 未完成 | 该用户收藏的笔记，查 interaction(type=2) + post |
| GET | /api/user/{userId}/likes | ❌ 未完成 | 该用户点赞的笔记，查 interaction(type=1) + post |

### 1.5 宠物（/api/pet、/api/user）

| 方法 | 路径 | 状态 | 说明 |
|------|------|------|------|
| GET | /api/user/{userId}/pets | ❌ 未完成 | 用户宠物列表，需 **pet 表** 及 PetVO 与前端 Pet 对齐 |
| POST | /api/pet/add | ✅ 已完成 | 添加宠物 |
| PUT | /api/pet/{id} | ⏸ 可选 | 编辑宠物，可后续迭代 |

### 1.6 通知（/api/notification）

| 方法 | 路径 | 状态 | 说明 |
|------|------|------|------|
| GET | /api/notification | ❌ 未完成 | type=comment\|like\|follow，page, size；可先不建 notification 表，用 comment/follow/interaction 实时拼 |

### 1.7 上传（可选）

| 方法 | 路径 | 状态 | 说明 |
|------|------|------|------|
| POST | /api/upload 或 /api/upload/image | ⏸ 可选 | 上传图片返回 URL，发布帖可先传 URL 不实现上传 |

---

## 二、数据库依赖

| 表名 | 设计文档中有 | 当前是否存在 | 需执行 |
|------|--------------|--------------|--------|
| user | 有 | 有（Entity 有） | 确认表结构含 account_id, nickname, avatar, last_login_ip 等 |
| post | 有 | 有 | 已有 |
| pet | 有 | 有（t_pet） | 确认字段与文档一致，或加 species/name 等映射 |
| interaction | 有 | 有 | 已有，target_id 已改为 Long |
| **comment** | 有 | **无** | **需建表 + Comment 实体 + CommentMapper** |
| **follow** | 有 | **无** | **需建表 + Follow 实体 + FollowMapper** |
| notification | 可选 | 无 | 可不建，用实时查 comment/follow/interaction |

**优先建表**：`comment`、`follow`。建表 SQL 可直接按设计文档 4.5、4.6 节建。

---

## 三、建议实施顺序（按依赖排）

按「先基础表与基础接口，再依赖它们的接口」的顺序做，便于每一步都能自测。

| 阶段 | 内容 | 产出 |
|------|------|------|
| **1** | 收藏接口 | POST /api/post/{id}/collect（复用 interaction，type=2），Service 里仿 toggleLike 写 toggleCollect |
| **2** | 发布帖子 | POST /api/post（Body: title, content, channel, images），PostMapper.insert，返回 id 或 PostCardVO |
| **3** | 建 comment 表 + 评论接口 | comment 表；GET/POST /api/post/{id}/comments；Comment 实体、CommentMapper、CommentVO、PostService 中评论方法 |
| **4** | 建 follow 表 + 关注接口 | follow 表；POST /api/user/{userId}/follow；Follow 实体、FollowMapper、UserService；帖子详情里 isFollowed 查 follow 表 |
| **5** | 用户资料与宠物列表 | GET /api/user/profile、GET /api/user/{userId}/profile（查 user + 统计 follow + 获赞收藏数 + pets）；GET /api/user/{userId}/pets；UserProfileVO、PetVO；UserMapper、PetMapper 查询方法 |
| **6** | 个人页三个列表 | GET /api/user/{userId}/posts、/collects、/likes（可复用 PostCardVO 与现有 feed/互动查询） |
| **7** | 通知接口 | GET /api/notification?type=&page=&size=，按 type 查 comment / interaction / follow 关联用户与帖子，拼成通知列表（可不建 notification 表） |

**今日可执行顺序**：1 → 2 → 3 → 4 → 5 → 6 → 7；若时间紧，可先做到 5（用户资料 + 宠物），6、7 次日完成。

---

## 四、每一步具体要做的事（清单）

### 阶段 1：收藏

- [ ] PostController：`POST /api/post/{id}/collect`，调 `postService.toggleCollect(currentUserId, id)`，返回 `Result<Boolean>`。
- [ ] PostService / PostServiceImpl：`toggleCollect(userId, postId)`，逻辑同 toggleLike，type=2。
- [ ] 无需新表、新 Mapper 方法（interaction 已支持 type=2）。

### 阶段 2：发布帖子

- [ ] 定义发布请求 DTO（如 PublishPostDTO：title, content, channel, images(List<String>), isPublic）。
- [ ] PostController：`POST /api/post`，Body 用 DTO，调 `postService.publish(currentUserId, dto)`，返回 `Result<PostCardVO>` 或 `Result<Long>`。
- [ ] PostMapper：`insert(Post)`，Post 实体已有；若表没有 is_public、location_tag，可先不加。
- [ ] PostServiceImpl：channel 转 category，images 转 JSON 字符串，setUserId，insert，返回新建的帖子信息或 id。

### 阶段 3：评论

- [ ] 建表：comment（id, post_id, user_id, parent_id, content, like_count, create_time）。
- [ ] Entity：Comment；Mapper：CommentMapper；XML：CommentMapper.xml（selectByPostId 分页、insert）。
- [ ] VO：CommentVO（与前端 Comment 一致：id, postId, userId, userName, userAvatar, content, likeCount, isLiked, createdAt, replyCount, replies, parentId）。
- [ ] PostController：GET /api/post/{id}/comments（page, size），POST /api/post/{id}/comments（Body: content, parentId?）。
- [ ] PostService：getComments(postId, page, size)、addComment(postId, userId, content, parentId)；组树或平铺带 replies。

### 阶段 4：关注

- [ ] 建表：follow（id, follower_id, followee_id, create_time），唯一 (follower_id, followee_id)。
- [ ] Entity：Follow；Mapper：FollowMapper（insert、delete、countByFollowee、countByFollower、exists）。
- [ ] UserService：toggleFollow(followerId, followeeId)；PostServiceImpl.getPostDetail 里查 follow 表设 isFollowed。
- [ ] 新建 UserController：`POST /api/user/{userId}/follow`（此处 userId 为被关注者 followeeId）。

### 阶段 5：用户资料与宠物列表

- [ ] UserMapper：selectById；统计 SQL：关注数、粉丝数、获赞与收藏数（interaction 里 type 1+2 的 count）。
- [ ] PetMapper：selectByUserId；PetVO 与前端 Pet 对齐（name, species, breed, gender, ageText, health, neutered 等），Entity 字段名不同则在 Service 或 VO 中映射。
- [ ] UserService：getProfile(userId)、getProfileCurrent()（当前用户即写死 1L 或后续从 Token 取）；getPets(userId)。
- [ ] UserController：GET /api/user/profile（当前），GET /api/user/{userId}/profile（他人），GET /api/user/{userId}/pets。
- [ ] VO：UserProfileVO（与前端 UserProfile 一致）、PetVO（与前端 Pet 一致）。

### 阶段 6：个人页三个列表

- [ ] UserController：GET /api/user/{userId}/posts、/collects、/likes（均分页 page, size）。
- [ ] UserService 或 PostService：三个方法分别查：post 表 by user_id；interaction(type=2)+post；interaction(type=1)+post；返回 List<PostCardVO>。

### 阶段 7：通知

- [ ] NotificationController：GET /api/notification?type=comment|like|follow&page=&size=。
- [ ] NotificationService：按 type 查 comment / interaction / follow，关联 user、post，拼成前端需要的通知列表结构（id, userAvatar, userName, content/action, postTitle, time 等）。

---

## 五、什么叫「后端全部开发好」——验收标准

满足以下条件，即可认为**后端接口全部开发完成、可以交给前端联调**：

1. **接口清单闭合**  
   设计文档里要求暴露给前端的接口（除标记为「可选」的 like-status、PUT /api/pet/{id}、上传）全部实现，且路径、方法、入参与文档一致。

2. **返回格式统一**  
   所有接口统一返回 `Result<T>`（code=200/500，msg，data）；列表接口返回 `Result<List<xxx>>`，分页参数 page、size 生效。

3. **与前端约定对齐**  
   - Feed/详情/评论/用户资料/宠物/通知 的返回字段与前端类型（PostCard、PostDetail、Comment、UserProfile、Pet、通知项）一致，前端可直接 `res.data.data` 使用。
   - 频道用 channel（字符串或中文），帖子用 category（数字）只在后端内部使用。

4. **无未实现依赖**  
   - 评论依赖 comment 表；关注与 isFollowed 依赖 follow 表；用户资料依赖 user、pet 及统计；通知可依赖现有表实时拼，不强制建 notification 表。

5. **后端可测**  
   - 本地能启动（Spring Boot + 数据库），无编译错误、无启动报错。
   - 每个接口至少有一种可重复的验证方式（见下节「测试方式」）。

---

## 六、建议的测试方式（达到即可认为「测过」）

### 6.1 手动测试（最小可行）

用 Postman / Apifox / curl 按下面清单跑一遍，全部通过即算后端接口验收通过：

| 接口 | 建议验证方式 |
|------|--------------|
| GET /api/post/feed | channel=all、adopt 各请求一次，检查返回列表、code=200 |
| GET /api/post/{id} | 取 feed 里一条 id 请求，检查详情、imageUrls、isLiked/isCollected/isFollowed |
| POST /api/post/{id}/like | 对某 id 调一次再调一次，检查返回 isLiked 先 true 后 false（或反之） |
| POST /api/post/{id}/collect | 同上，检查 isCollected 状态 |
| POST /api/post | Body 传 title、content、channel、images，检查返回 200 且 feed 里能出现新帖 |
| GET /api/post/{id}/comments | 检查分页、结构含 userName、userAvatar、replies（若有） |
| POST /api/post/{id}/comments | 发一条根评论、一条回复，再 GET 检查列表 |
| POST /api/user/{userId}/follow | 对某用户关注再取关，检查返回或 profile 中关注数变化 |
| GET /api/user/profile 或 /api/user/1/profile | 检查用户信息、关注/粉丝/获赞数、pets 列表 |
| GET /api/user/{userId}/pets | 检查返回宠物列表，字段与前端一致 |
| GET /api/user/{userId}/posts、/collects、/likes | 各请求一次，检查返回 PostCard 列表、分页 |
| GET /api/notification?type=comment&page=1&size=10 | 三种 type 各请求一次，检查列表结构 |

### 6.2 自动化测试（可选）

- 在 `pet_book/src/test` 下用 MockMvc 或 RestAssured 对上述接口写集成测试：请求 + 断言 `Result.code==200` 及必要字段存在。
- 有 CI 时跑 `mvn test`，全部通过作为「后端开发完成」的自动化标准。

---

## 七、今日小结：你还缺什么、接下来怎么做

**还没完成的：**

- 接口：**收藏、发布帖子、评论（GET+POST）、关注、用户资料（当前+他人）、用户宠物列表、个人页三个列表、通知列表**。
- 数据库：**comment 表、follow 表**（若库里还没有）。
- 代码：**UserController、UserService、CommentMapper/Comment 实体、FollowMapper/Follow 实体**，以及 Post 侧的评论、收藏、发布逻辑。

**建议今天按顺序做：**

1. 做 **阶段 1（收藏）** 和 **阶段 2（发布帖子）**，改动的都是现有 Post 相关代码，快且无新表。
2. 建 **comment、follow 表**，接着做 **阶段 3（评论）**、**阶段 4（关注）**。
3. 做 **阶段 5（用户资料 + 宠物）**，需要新建 UserController、UserService、UserMapper（若还没有）、PetMapper 查询及 PetVO。
4. 再做 **阶段 6（个人页三个列表）**、**阶段 7（通知）**。

**验收标准：**  
当上述「五、验收标准」全部满足，且「六、测试方式」中手动测试清单（或你补充的自动化测试）全部通过时，即可认为**后端全部开发完成**，可以交给前端联调。
