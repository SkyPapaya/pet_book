# 宠物书后端接口与数据库设计文档

本文档基于当前前端页面（首页、发布笔记、消息通知、个人主页、帖子详情弹窗）梳理：前端需要的数据、应暴露的接口、数据库表设计及后端实现要点。

---

## 一、前端需要的数据与获取方式总览

| 页面/功能 | 需要的数据 | 获取方式建议 |
|-----------|------------|--------------|
| **首页 HomeView** | 帖子卡片列表（分频道、分页） | `GET /api/post/feed`，参数：channel, page, size |
| **帖子详情弹窗 PostDetailModal** | 帖子详情（标题、正文、多图、作者、点赞/收藏/评论数、是否已点赞/收藏/关注） | 列表项点击时用已有数据 或 `GET /api/post/{id}` 拉详情 |
| **帖子详情弹窗** | 评论列表（分页、含子评论） | `GET /api/post/{id}/comments`，参数：page, size |
| **首页/详情** | 点赞、收藏、关注状态变更 | `POST /api/post/{id}/like`、`/collect`、`POST /api/user/{id}/follow` |
| **发布笔记 PublishPostView** | 发布新帖、上传图片/视频 | `POST /api/post`（含媒体 URL 或先传文件再传 URL）、可选 `POST /api/upload` |
| **个人主页 ProfileView** | 当前用户资料（含关注/粉丝/获赞与收藏、宠物列表） | `GET /api/user/profile`（当前登录）或 `GET /api/user/{userId}/profile` |
| **个人主页** | 我的笔记 / 我的收藏 / 我的点赞 列表 | `GET /api/user/{id}/posts`、`/collects`、`/likes`，可分页 |
| **消息通知 NotificationView** | 评论和@、赞和收藏、新增关注 三类列表 | `GET /api/notification`，参数：type=comment|like|follow，page, size |

前端已有类型定义（`pet-book-web/src/types/index.ts`）可作为接口契约参考：`PostCard`、`PostDetail`、`Comment`、`UserProfile`、`Pet`、`UserBrief`。

---

## 二、应暴露的接口清单

### 2.1 帖子

| 方法 | 路径 | 说明 | 前端使用处 |
|------|------|------|------------|
| GET | `/api/post/feed` | 瀑布流列表，按频道、分页 | HomeView |
| GET | `/api/post/{id}` | 帖子详情（含作者简要、是否已点赞/收藏/关注） | PostDetailModal（按需按 id 拉取） |
| POST | `/api/post` | 发布笔记（标题、正文、频道、图片/视频 URL 列表、话题、是否公开等） | PublishPostView |

**feed 参数约定（与前端对齐）**  
- `channel`: 可选，`all` | `adopt` | `knowledge` | `help`；不传或 `all` 表示推荐（全部）。  
- `page`: 页码，从 1 开始。  
- `size`: 每页条数（前端当前 16）。

### 2.2 帖子互动

| 方法 | 路径 | 说明 | 前端使用处 |
|------|------|------|------------|
| POST | `/api/post/{id}/like` | 点赞/取消点赞 | HomeView 卡片、PostDetailModal |
| POST | `/api/post/{id}/collect` | 收藏/取消收藏 | PostDetailModal |
| GET | `/api/post/{id}/like-status` | 可选：查询当前用户是否已点赞/收藏 | 详情页初始化 |

### 2.3 评论

| 方法 | 路径 | 说明 | 前端使用处 |
|------|------|------|------------|
| GET | `/api/post/{id}/comments` | 评论列表分页（含子评论，按点赞或时间排序） | PostDetailModal |
| POST | `/api/post/{id}/comments` | 发表评论（可带 parentId 表示回复某条评论） | PostDetailModal |

建议参数：`page`、`size`；返回结构需支持 `Comment[]`，每条可有 `replies: Comment[]`。

### 2.4 用户与关注

| 方法 | 路径 | 说明 | 前端使用处 |
|------|------|------|------------|
| GET | `/api/user/profile` | 当前登录用户资料（含关注数、粉丝数、获赞与收藏数、宠物列表） | ProfileView、SideBar |
| GET | `/api/user/{userId}/profile` | 他人主页资料（同上，不含敏感信息） | 从帖子/评论跳转个人页 |
| POST | `/api/user/{userId}/follow` | 关注/取关 | PostDetailModal、他人主页 |

### 2.5 个人页内容列表

| 方法 | 路径 | 说明 | 前端使用处 |
|------|------|------|------------|
| GET | `/api/user/{userId}/posts` | 该用户发布的笔记列表（分页） | ProfileView - 笔记 Tab |
| GET | `/api/user/{userId}/collects` | 该用户收藏的笔记列表（分页） | ProfileView - 收藏 Tab |
| GET | `/api/user/{userId}/likes` | 该用户点赞的笔记列表（分页） | ProfileView - 点赞 Tab |

列表项结构可与 `PostCard` 一致，便于复用前端卡片组件。

### 2.6 宠物

| 方法 | 路径 | 说明 | 前端使用处 |
|------|------|------|------------|
| GET | `/api/user/{userId}/pets` | 用户的宠物列表 | ProfileView - 我的宠物 |
| POST | `/api/pet` 或 `/api/pet/add` | 添加宠物（与现有 PetController 对齐） | 后续「添加宠物」功能 |
| PUT | `/api/pet/{id}` | 编辑宠物（可选） | 后续编辑宠物 |

### 2.7 通知

| 方法 | 路径 | 说明 | 前端使用处 |
|------|------|------|------------|
| GET | `/api/notification` | 通知列表，type=comment|like|follow，分页 | NotificationView 三个 Tab |

返回每条通知需包含：类型、触发用户（头像、昵称）、目标帖子/评论摘要、时间等，与前端 mock 结构一致即可。

### 2.8 上传（可选）

| 方法 | 路径 | 说明 | 前端使用处 |
|------|------|------|------------|
| POST | `/api/upload` 或 `/api/upload/image` | 上传图片/视频，返回 URL 列表 | PublishPostView 选择图片后先上传再提交帖子 |

若暂时不实现上传，可让前端使用占位图或外链，发布时 `POST /api/post` 的 body 中直接带图片 URL 数组。

---

## 三、前端数据结构与接口字段对齐

以下字段需与后端统一，便于前端直接使用 `res.data.data` 赋值给现有类型。

### 3.1 帖子流 GET /api/post/feed

- **请求参数**：`channel`（string，可选）、`page`（number）、`size`（number）。  
- **后端建议**：`channel` 与数据库 `post.category` 映射关系：  
  - `adopt` → 1，`knowledge` → 2，`help` → 3；  
  - `all` 或不传 → 不按 category 过滤。  
- **返回每条（PostCard）**：  
  `id`, `title`, `coverUrl`, `coverAspectRatio?`, `authorName`, `authorAvatar`, `likeCount`, `channel?`, `desc?`。  
- **说明**：当前后端 `PostController` 使用 `category`、`page`、`pageSize`，前端使用 `channel`、`page`、`size`。建议后端同时接受 `channel` 与 `size`，并在内部做映射与分页（例如 `size` 作为 pageSize）。

### 3.2 帖子详情 GET /api/post/{id}

- **返回（PostDetail）**：  
  `id`, `title`, `desc`, `imageUrls[]`, `authorId`, `authorName`, `authorAvatar`, `likeCount`, `collectCount`, `commentCount`, `isLiked`, `isCollected`, `isFollowed`, `createdAt`, `publishIp?`。  
- **说明**：若当前用户未登录，`isLiked`/`isCollected`/`isFollowed` 可为 false；`publishIp` 可按合规要求做脱敏或省略。

### 3.3 评论 GET /api/post/{id}/comments

- **返回**：`Comment[]`，每条含 `id`, `postId`, `userId`, `userName`, `userAvatar`, `content`, `likeCount`, `isLiked`, `createdAt`, `replyCount?`, `replies?: Comment[]`, `parentId?`。  
- 根评论 `parentId` 为空；子评论 `parentId` 为父评论 id。后端可按 `parentId` 组装树或平铺带 `replies` 的结构。

### 3.4 用户资料 GET /api/user/profile 或 GET /api/user/{userId}/profile

- **返回（UserProfile）**：  
  `id`, `nickname`, `avatar`, `accountId`, `ip`, `signature`, `gender`, `age`, `location`, `profession`, `followingCount`, `followersCount`, `likesAndCollectCount`, `pets?: Pet[]`。  
- **Pet**：`id`, `name`, `avatar`, `species`, `breed?`, `gender`, `birthday?`, `ageText?`, `health`, `neutered?`。  
- 当前后端 `Pet` 实体字段与前端不完全一致（如 nickname vs name、type vs species），需在 VO 或 Service 层做映射。

### 3.5 通知 GET /api/notification

- **请求参数**：`type`（comment | like | follow）、`page`、`size`。  
- **返回**：与 NotificationView 中 commentList / likeList / followList 结构一致即可（id、用户头像昵称、内容/动作、帖子标题、时间等）。

---

## 四、数据库表设计

以下表结构在现有 `post`、`user`、`pet`、`interaction` 等基础上做统一设计，便于实现上述接口。

### 4.1 user 表（用户）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT PK AUTO_INCREMENT | 用户ID |
| account_id | VARCHAR(64) UNIQUE NOT NULL | 宠物书号，唯一 |
| nickname | VARCHAR(64) | 昵称 |
| avatar | VARCHAR(512) | 头像 URL |
| gender | TINYINT | 0未知 1男 2女 |
| age | TINYINT | 年龄 |
| location | VARCHAR(128) | 所在地 |
| profession | VARCHAR(64) | 职业 |
| signature | VARCHAR(512) | 签名/简介 |
| last_login_ip | VARCHAR(64) | 最近登录 IP（用于展示 IP 属地） |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

关注数、粉丝数、获赞与收藏数可通过统计表计算，不必在 user 表冗余（或做冗余并定时/异步更新）。

### 4.2 post 表（帖子）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT PK AUTO_INCREMENT | 帖子ID |
| user_id | BIGINT NOT NULL | 发布者ID |
| category | TINYINT NOT NULL | 频道：1领养 2知识 3求助 |
| title | VARCHAR(256) NOT NULL | 标题 |
| content | TEXT | 正文/简介 |
| images | JSON / VARCHAR(2000) | 图片 URL 数组，如 ["url1","url2"] |
| status | TINYINT DEFAULT 1 | 0审核中 1已发布 2未通过 |
| is_public | TINYINT DEFAULT 1 | 是否公开 |
| location_tag | VARCHAR(128) | 标记地点（可选） |
| create_time | DATETIME | 发布时间 |
| update_time | DATETIME | 更新时间 |

与现有 `Post` 实体基本一致，可增加 `is_public`、`location_tag` 等以支持发布页选项。

### 4.3 pet 表（宠物）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT PK AUTO_INCREMENT | 宠物ID |
| user_id | BIGINT NOT NULL | 主人用户ID |
| name | VARCHAR(64) | 宠物名（与前端 name 对应） |
| avatar | VARCHAR(512) | 头像 URL |
| species | VARCHAR(32) | 种类：猫、狗等（可与 type 映射） |
| breed | VARCHAR(64) | 品种 |
| gender | TINYINT | 0未知 1公 2母 |
| birthday | DATE | 生日 |
| age_text | VARCHAR(32) | 年龄展示文案，如 2岁、3个月 |
| health | VARCHAR(256) | 健康情况 |
| neutered | TINYINT | 是否绝育 0否 1是 |
| status | TINYINT | 状态（可选） |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

若当前表为 `nickname`、`type`，可保留并在 Mapper/VO 中映射为 `name`、`species`。

### 4.4 interaction 表（点赞、收藏等）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT PK AUTO_INCREMENT | 主键 |
| user_id | BIGINT NOT NULL | 用户ID |
| target_type | TINYINT NOT NULL | 1帖子 2评论（可扩展） |
| target_id | BIGINT NOT NULL | 帖子ID或评论ID |
| type | TINYINT NOT NULL | 1点赞 2收藏 |
| create_time | DATETIME | 创建时间 |

唯一索引：`(user_id, target_type, target_id, type)`，便于“点赞/取消点赞”用 insert/delete 实现。  
收藏与点赞可共用一表，用 `type` 区分；或拆成 `like`、`collect` 两张表，按项目习惯即可。

### 4.5 comment 表（评论）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT PK AUTO_INCREMENT | 评论ID |
| post_id | BIGINT NOT NULL | 帖子ID |
| user_id | BIGINT NOT NULL | 评论者ID |
| parent_id | BIGINT | 父评论ID，NULL 表示根评论 |
| content | TEXT NOT NULL | 评论内容 |
| like_count | INT DEFAULT 0 | 点赞数（可冗余） |
| create_time | DATETIME | 创建时间 |

索引：`post_id`、`parent_id`，便于按帖子查评论及组树。

### 4.6 follow 表（关注）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT PK AUTO_INCREMENT | 主键 |
| follower_id | BIGINT NOT NULL | 关注者（粉丝） |
| followee_id | BIGINT NOT NULL | 被关注者 |
| create_time | DATETIME | 关注时间 |

唯一索引：`(follower_id, followee_id)`。

### 4.7 comment_like 表（评论点赞，可选）

若评论点赞与帖子点赞分开统计，可单独建表，结构类似 interaction：`user_id`、`comment_id`、`create_time`。  
也可复用 `interaction`（target_type=2、target_id=comment_id、type=1）。

### 4.8 notification 表（通知，可选）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT PK AUTO_INCREMENT | 主键 |
| user_id | BIGINT NOT NULL | 接收通知的用户 |
| type | TINYINT NOT NULL | 1评论 2@ 3赞 4收藏 5关注 |
| actor_id | BIGINT | 触发者用户ID |
| post_id | BIGINT | 关联帖子（可选） |
| comment_id | BIGINT | 关联评论（可选） |
| content | VARCHAR(512) | 摘要或冗余文案 |
| is_read | TINYINT DEFAULT 0 | 是否已读 |
| create_time | DATETIME | 创建时间 |

也可不建表，在评论/点赞/关注发生时实时查最近记录拼成“通知列表”，视产品需求选择。

---

## 五、后端实现要点

### 5.1 统一前缀与跨域

- 前端请求为 `/api/post/feed`、`/api/user/profile` 等，建议后端统一使用 `/api` 前缀（如 `@RequestMapping("/api")` 在类上，或通过网关/反向代理转发）。  
- 若前端与后端同域，可不跨域；否则在 Controller 或全局配置中保留 `@CrossOrigin` 或 CORS 配置。

### 5.2 参数与返回值对齐

- **PostController.getFeedList**：  
  - 接受 `channel`（String）、`page`、`size`；  
  - 将 `channel` 转为 `category`（all→null，adopt→1，knowledge→2，help→3）；  
  - 返回 `Result<List<PostCardVO>>`，且 `PostCardVO` 中 `id` 建议为 Long/Number（前端 PostCard.id 为 number），并增加 `coverAspectRatio`、`channel`（中文）、`desc` 等字段以便前端直接使用。  
- **PostCardVO** 与前端 `PostCard` 对齐：id、title、coverUrl、coverAspectRatio、authorName、authorAvatar、likeCount、channel、desc。

### 5.3 帖子详情接口

- 新建 `GET /api/post/{id}`：  
  - 根据 id 查 post，关联 user 得到作者信息；  
  - 查 interaction 表得到当前用户对该帖的点赞、收藏状态；  
  - 查 follow 表得到是否已关注作者；  
  - 组装为 `PostDetailVO`（与前端 PostDetail 一致），包含 imageUrls、collectCount、commentCount、isLiked、isCollected、isFollowed、createdAt、publishIp 等。

### 5.4 评论接口

- **GET /api/post/{id}/comments**：  
  - 按 post_id 查 comment，分页；  
  - 根评论与子评论可一次查完再在内存中组树，或先查根评论分页再按根评论 id 查 replies。  
  - 每条评论需要评论者 nickname、avatar（关联 user 表），以及当前用户是否已点赞该评论（查 comment_like 或 interaction）。  
- **POST /api/post/{id}/comments**：  
  - Body：content、parentId（可选）；  
  - 插入 comment 表，并可选写 notification 表或发消息。

### 5.5 点赞、收藏、关注

- 点赞/收藏：在 Service 中根据 `interaction` 是否存在做 insert 或 delete，并更新 post 表冗余的 like_count、collect_count（若有）；返回最新 count 或 200 即可。  
- 关注：在 follow 表 insert/delete，并可选更新 user 表冗余的 following_count、followers_count。

### 5.6 用户与宠物

- **GET /api/user/profile**：从登录上下文取 userId，查 user 表 + 关注/粉丝/获赞与收藏统计 + 该用户的 pet 列表，组装 UserProfileVO（含 Pet 列表，字段与前端 Pet、UserProfile 一致）。  
- **GET /api/user/{userId}/pets**：查 pet 表，按 userId 过滤，返回 List<PetVO>。  
- Pet 实体与前端 Pet 的映射：nickname→name、type→species、gender 数值→male/female 等，在 VO 或 Service 中统一转换。

### 5.7 发布帖子

- **POST /api/post**：  
  - Body：title、content、channel（adopt/knowledge/help）、images[]、isPublic、locationTag、hashtags[] 等；  
  - 将 channel 转为 category，将 images 存为 JSON 字符串或 JSON 类型；  
  - 若暂无登录，可先写死 userId 或从 Token 解析；插入 post 表后返回完整 Post 或 id。

### 5.8 通知

- **GET /api/notification**：  
  - 参数 type、page、size；  
  - 若用 notification 表：按 user_id、type 查询并分页；  
  - 若实时拼：根据 type 查 comment/follow/interaction 等表，关联用户与帖子信息，按时间排序后分页返回。

### 5.9 个人页三个列表

- **GET /api/user/{userId}/posts**：按 user_id 查 post 表，分页，返回与 feed 相同的 PostCard 结构。  
- **GET /api/user/{userId}/collects**：通过 interaction 表（type=收藏、target_type=帖子）得到 post_id 列表，再查 post 与作者，组装 PostCard 列表。  
- **GET /api/user/{userId}/likes**：同上，type=点赞。

### 5.10 分层与安全

- **Controller**：只做参数校验、调用 Service、返回 Result。  
- **Service**：业务逻辑、统计、组装 VO、事务。  
- **Mapper**：仅做数据库访问；复杂统计可用 XML 或多表联查。  
- 后续接入登录后，从 Token 取当前 userId，用于 isLiked、isCollected、isFollowed、发表评论、发布帖子等；未登录时这些接口可返回 401 或默认未点赞/未关注。

---

## 六、接口与数据流小结

- **首页**：`GET /api/post/feed?channel=&page=&size=` → PostCard 列表。  
- **帖子详情**：列表点击可先用列表项拼 PostDetail，或再请求 `GET /api/post/{id}`；评论用 `GET /api/post/{id}/comments`；点赞/收藏/关注用对应 POST。  
- **发布**：`POST /api/post`（与上传接口可选配合）。  
- **个人页**：`GET /api/user/profile` 或 `GET /api/user/{userId}/profile` → UserProfile + pets；笔记/收藏/点赞用三个 GET 列表。  
- **通知**：`GET /api/notification?type=&page=&size=` → 三类通知列表。  

按上述表结构与接口实现后，前端只需把 mock 数据替换为上述 API 调用，并统一 baseURL（如 axios 配置 `baseURL: '/api'` 或实际后端地址）即可对接。
